var.basedir = "/var/www"
var.logdir = "/var/log/lighttpd"
var.statedir = "/var/run/lighttpd"

server.modules = (
    "mod_cgi",
    "mod_proxy",
    "mod_access",
    "mod_accesslog",
    "mod_compress",
    "mod_staticfile",
    "mod_openssl",
    "mod_rewrite"
)

server.document-root = "/var/www/xintuxiangce"
server.pid-file = "/var/run/lighttpd/lighttpd.pid"
server.port = 80

server.username = "lighttpd"
server.groupname = "lighttpd"

index-file.names = ( "index.html" )

mimetype.assign = (
  ".html" => "text/html",
  ".htm" => "text/html",
  ".txt" => "text/plain",
  ".jpg" => "image/jpeg",
  ".jpeg" => "image/jpeg",
  ".png" => "image/png",
  ".gif" => "image/gif",
  ".css" => "text/css",
  ".js" => "application/javascript",
  ".json" => "application/json",
  ".xml" => "application/xml",
  ".svg" => "image/svg+xml",
  ".ico" => "image/x-icon",
  ".exe" => "application/x-msdownload",
  "" => "application/octet-stream"
)

compress.cache-dir = "/var/cache/lighttpd/compress/"
compress.filetype = ("text/html", "text/plain", "text/css", "application/javascript")                                                                               

server.error-handler-404 = "/404.html"

accesslog.filename = var.logdir + "/access.log"

# CGI配置
cgi.assign = ( ".py" => "/usr/bin/python3" )

# SSL配置
["socket"] == ":443" {
    ssl.engine = "enable"
    ssl.pemfile = "/etc/letsencrypt/live/www.xintuxiangce.top/fullchain.pem"      
    ssl.privkey = "/etc/letsencrypt/live/www.xintuxiangce.top/privkey.pem"        

    # 现代化SSL配置
    ssl.cipher-list = "ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384"                                     
    ssl.honor-cipher-order = "enable"
    ssl.use-sslv2 = "disable"
    ssl.use-sslv3 = "disable"

    setenv.add-response-header = (
        "Strict-Transport-Security" => "max-age=31536000; includeSubDomains; preload",
        "X-Content-Type-Options" => "nosniff",
        "Referrer-Policy" => "strict-origin-when-cross-origin"
    )

    ["url"] =~ "^/api/" {
        proxy.server = ( "" => (
            ( "host" => "127.0.0.1", "port" => 8000 )
        ))
    }
    
    # 转发支付相关页面到8000端口（HTTPS）
    ["url"] =~ "^/(member|credits|credits_info)\.html$" {
        proxy.server = ( "" => (
            ( "host" => "127.0.0.1", "port" => 8000 )
        ))
    }
    
    # 转发图片文件到8000端口
    ["url"] =~ "^/images/" {
        proxy.server = ( "" => (
            ( "host" => "127.0.0.1", "port" => 8000 )
        ))
    }
}

# HTTP端口配置
["socket"] == ":80" {
    url.redirect = ("^/(.*)" => "https://www.xintuxiangce.top/")

    # API路径反向代理到8000端口（不会触发，因为已被上方redirect覆盖；保留以备需要）
    ["url"] =~ "^/api/" {
        proxy.server = ( "" => (
            ( "host" => "127.0.0.1", "port" => 8000 )
        ))
    }
    
    # 转发支付相关页面到8000端口（同上注释）
    ["url"] =~ "^/(member|credits|credits_info)\.html$" {
        proxy.server = ( "" => (
            ( "host" => "127.0.0.1", "port" => 8000 )
        ))
    }
    
    # 转发图片文件到8000端口（同上注释）
    ["url"] =~ "^/images/" {
        proxy.server = ( "" => (
            ( "host" => "127.0.0.1", "port" => 8000 )
        ))
    }
}
