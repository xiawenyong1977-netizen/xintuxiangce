<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO TDK - éœ€è¦æ›¿æ¢ -->
    <title>V2æ¥å£æŠ€æœ¯æ–¹æ¡ˆæ€»ç»“ï¼šå¤§æ¨¡å‹æœåŠ¡åˆ†å±‚æ¶æ„ä¸ç»Ÿä¸€ç¼“å­˜è®¾è®¡ | èŠ¯å›¾æ—¥è®°</title>
    <meta name="description" content="è¯¦ç»†ä»‹ç»èŠ¯å›¾ç›¸å†ŒV2æ¥å£çš„æŠ€æœ¯æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬å¤§æ¨¡å‹æœåŠ¡ä¸‰å±‚æ¶æ„ï¼ˆåŸºç¡€æœåŠ¡å±‚ã€Providerå±‚ã€ä¸šåŠ¡å±‚ï¼‰ã€ç»Ÿä¸€ç¼“å­˜æ¶æ„ã€ä½ç½®æœåŠ¡ç­‰æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆã€‚æ·±å…¥è§£æå›¾åƒåˆ†ç±»ã€é¢œè‰²åˆ†ç±»ã€æ„å›¾åˆ†æã€å›¾åƒç¼–è¾‘ã€æ–‡æœ¬ç”Ÿæˆç­‰5å¤§æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼Œä»¥åŠæ™ºèƒ½ä½ç½®æœåŠ¡çš„å¤šçº§é™çº§ç­–ç•¥å’Œæ•°æ®è§„èŒƒåŒ–æœºåˆ¶ï¼Œä¸ºå›¾åƒæ™ºèƒ½å¤„ç†å’Œä½ç½®æœåŠ¡æä¾›ç¨³å®šã€é«˜æ•ˆã€å¯æ‰©å±•çš„æŠ€æœ¯åŸºç¡€ã€‚">
    <meta name="keywords" content="æŠ€æœ¯æ¶æ„, V2æ¥å£, å¤§æ¨¡å‹, ç¼“å­˜æ¶æ„, ä½ç½®æœåŠ¡, ç³»ç»Ÿè®¾è®¡, ç ”å‘ç»éªŒ">
    
    <!-- Open Graph -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="V2æ¥å£æŠ€æœ¯æ–¹æ¡ˆæ€»ç»“ï¼šå¤§æ¨¡å‹æœåŠ¡åˆ†å±‚æ¶æ„ä¸ç»Ÿä¸€ç¼“å­˜è®¾è®¡">
    <meta property="og:description" content="è¯¦ç»†ä»‹ç»èŠ¯å›¾ç›¸å†ŒV2æ¥å£çš„æŠ€æœ¯æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬å¤§æ¨¡å‹æœåŠ¡ä¸‰å±‚æ¶æ„ï¼ˆåŸºç¡€æœåŠ¡å±‚ã€Providerå±‚ã€ä¸šåŠ¡å±‚ï¼‰ã€ç»Ÿä¸€ç¼“å­˜æ¶æ„ã€ä½ç½®æœåŠ¡ç­‰æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆã€‚æ·±å…¥è§£æå›¾åƒåˆ†ç±»ã€é¢œè‰²åˆ†ç±»ã€æ„å›¾åˆ†æã€å›¾åƒç¼–è¾‘ã€æ–‡æœ¬ç”Ÿæˆç­‰5å¤§æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼Œä»¥åŠæ™ºèƒ½ä½ç½®æœåŠ¡çš„å¤šçº§é™çº§ç­–ç•¥å’Œæ•°æ®è§„èŒƒåŒ–æœºåˆ¶ï¼Œä¸ºå›¾åƒæ™ºèƒ½å¤„ç†å’Œä½ç½®æœåŠ¡æä¾›ç¨³å®šã€é«˜æ•ˆã€å¯æ‰©å±•çš„æŠ€æœ¯åŸºç¡€ã€‚">
    <meta property="og:image" content="/assets/diary/backend-arch/cover.png">
    <meta property="og:url" content="https://www.xintuxiangce.top/diary/v2-architecture.html">
    
    <!-- ç»“æ„åŒ–æ•°æ® - Article -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "V2æ¥å£æŠ€æœ¯æ–¹æ¡ˆæ€»ç»“ï¼šå¤§æ¨¡å‹æœåŠ¡åˆ†å±‚æ¶æ„ä¸ç»Ÿä¸€ç¼“å­˜è®¾è®¡",
        "description": "è¯¦ç»†ä»‹ç»èŠ¯å›¾ç›¸å†ŒV2æ¥å£çš„æŠ€æœ¯æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬å¤§æ¨¡å‹æœåŠ¡ä¸‰å±‚æ¶æ„ï¼ˆåŸºç¡€æœåŠ¡å±‚ã€Providerå±‚ã€ä¸šåŠ¡å±‚ï¼‰ã€ç»Ÿä¸€ç¼“å­˜æ¶æ„ã€ä½ç½®æœåŠ¡ç­‰æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆã€‚æ·±å…¥è§£æå›¾åƒåˆ†ç±»ã€é¢œè‰²åˆ†ç±»ã€æ„å›¾åˆ†æã€å›¾åƒç¼–è¾‘ã€æ–‡æœ¬ç”Ÿæˆç­‰5å¤§æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼Œä»¥åŠæ™ºèƒ½ä½ç½®æœåŠ¡çš„å¤šçº§é™çº§ç­–ç•¥å’Œæ•°æ®è§„èŒƒåŒ–æœºåˆ¶ï¼Œä¸ºå›¾åƒæ™ºèƒ½å¤„ç†å’Œä½ç½®æœåŠ¡æä¾›ç¨³å®šã€é«˜æ•ˆã€å¯æ‰©å±•çš„æŠ€æœ¯åŸºç¡€ã€‚",
        "image": "/assets/diary/backend-arch/cover.png",
        "author": {
            "@type": "Organization",
            "name": "èŠ¯å›¾å›¢é˜Ÿ"
        },
        "publisher": {
            "@type": "Organization",
            "name": "èŠ¯å›¾ç›¸å†Œ"
        },
        "datePublished": "2026å¹´01æœˆ06æ—¥",
        "dateModified": "2026å¹´01æœˆ06æ—¥"
    }
    </script>
    
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "é¦–é¡µ",
                "item": "https://www.xintuxiangce.top"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "èŠ¯å›¾æ—¥è®°",
                "item": "https://www.xintuxiangce.top/diary.html"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "V2æ¥å£æŠ€æœ¯æ–¹æ¡ˆæ€»ç»“ï¼šå¤§æ¨¡å‹æœåŠ¡åˆ†å±‚æ¶æ„ä¸ç»Ÿä¸€ç¼“å­˜è®¾è®¡",
                "item": "https://www.xintuxiangce.top/diary/v2-architecture.html"
            }
        ]
    }
    </script>
    
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" type="image/png" href="/icons/imageclassify.png">
    
    <!-- ç»„ä»¶åŠ è½½å™¨ - å¿…é¡»åœ¨bodyä¹‹å‰åŠ è½½ -->
    <script src="../components-loader.js"></script>
    
    <style>
        .article-header {
            max-width: 800px;
            margin: 0 auto 60px;
            text-align: center;
            padding: 40px 20px 0;
        }
        
        .article-header h1 {
            font-size: 36px;
            line-height: 1.3;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .article-meta {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 40px;
        }
        
        .article-cover {
            width: 100%;
            max-width: 800px;
            margin: 0 auto 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }
        
        .article-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px 30px;
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-primary);
        }
        
        .article-content h2 {
            font-size: 28px;
            margin: 40px 0 20px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
        }
        
        .article-content h3 {
            font-size: 22px;
            margin: 30px 0 15px;
            color: var(--text-primary);
        }
        
        .article-content p {
            margin-bottom: 20px;
        }
        
        .article-content ul,
        .article-content ol {
            margin: 20px 0;
            padding-left: 30px;
        }
        
        .article-content li {
            margin-bottom: 10px;
        }
        
        .article-content code {
            background: var(--bg-light);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .article-content pre {
            background: var(--bg-light);
            padding: 20px;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .article-content pre code {
            background: none;
            padding: 0;
        }
        
        .article-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 20px 0;
        }
        
        .article-tag {
            padding: 6px 14px;
            background: var(--primary-light);
            color: var(--primary-color);
            border-radius: 16px;
            font-size: 14px;
        }
        
        .article-footer {
            max-width: 800px;
            margin: 60px auto;
            padding: 40px 20px;
            background: var(--bg-light);
            border-radius: var(--radius-lg);
            text-align: center;
        }
        
        .back-btn {
            display: inline-block;
            padding: 12px 32px;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-md);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .back-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .related-articles {
            max-width: 800px;
            margin: 30px auto 40px;
            padding: 40px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-top: 3px solid #667eea;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .related-articles h2 {
            font-size: 24px;
            margin-bottom: 30px;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .related-articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .related-article-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: block;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .related-article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .related-article-card h3 {
            font-size: 18px;
            margin: 0 0 10px 0;
            color: #667eea;
            font-weight: 600;
        }
        
        .related-article-card p {
            font-size: 14px;
            color: #666;
            margin: 0;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            .article-header h1 {
                font-size: 28px;
            }
            
            .article-content {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ å’Œåº•éƒ¨æ å°†é€šè¿‡ components-loader.js è‡ªåŠ¨åŠ è½½ -->
    
    <main>
        <article>
            <header class="article-header">
                <h1>V2æ¥å£æŠ€æœ¯æ–¹æ¡ˆæ€»ç»“ï¼šå¤§æ¨¡å‹æœåŠ¡åˆ†å±‚æ¶æ„ä¸ç»Ÿä¸€ç¼“å­˜è®¾è®¡</h1>
                <div class="article-meta">
                    <span>ğŸ“… 2026å¹´01æœˆ06æ—¥</span>
                    <span>âœï¸ èŠ¯å›¾å›¢é˜Ÿ</span>
                    <span>â±ï¸ 30åˆ†é’Ÿ</span>
                </div>
                <img src="/assets/diary/backend-arch/cover.png" alt="V2æ¥å£æŠ€æœ¯æ–¹æ¡ˆæ€»ç»“ï¼šå¤§æ¨¡å‹æœåŠ¡åˆ†å±‚æ¶æ„ä¸ç»Ÿä¸€ç¼“å­˜è®¾è®¡" class="article-cover">
            </header>
            
            <div class="article-content">
                <h2>ä¸€ã€å¤§æ¨¡å‹æœåŠ¡åˆ†å±‚æ¶æ„</h2>
<h3>1.1 æ¶æ„æ¦‚è§ˆ</h3>
<p>V2æ¥å£é‡‡ç”¨åˆ†æ¶æ„è®¾è®¡ï¼Œå®ç°äº†æ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œç»Ÿä¸€çš„æ¥å£æŠ½è±¡ï¼š</p>
<img src="/assets/diary/layeredarch/layered-arch.png" alt="åˆ†å±‚æŠ€æœ¯æ¶æ„" style="max-width: 100%; height: auto; margin: 20px 0; border-radius: 8px;">
<h3>1.2 åŸºç¡€æœåŠ¡å±‚ (Base Service Layer)</h3>
<p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>app/services/llm/base_service.py</code></p>
<p><strong>æ ¸å¿ƒèŒè´£</strong>:</p>
<ul>
<li>ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œåˆ†ç±»</li>
<li>è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰</li>
<li>è¶…æ—¶æ§åˆ¶</li>
<li>ç»Ÿä¸€çš„æ—¥å¿—è®°å½•</li>
<li>é”™è¯¯ç±»å‹æšä¸¾å’Œè½¬æ¢</li>
</ul>
<p><strong>å…³é”®ç‰¹æ€§</strong>:</p>
<ul>
<li><strong>é”™è¯¯ç±»å‹åˆ†ç±»</strong>:</li>
<li>å¯é‡è¯•é”™è¯¯: <code>NETWORK_ERROR</code>, <code>SERVER_ERROR</code>, <code>RATE_LIMIT_ERROR</code>, <code>FORMAT_ERROR</code></li>
<li>ä¸å¯é‡è¯•é”™è¯¯: <code>INPUT_ERROR</code>, <code>AUTH_ERROR</code>, <code>BUSINESS_ERROR</code></li>
<li><strong>é‡è¯•ç­–ç•¥</strong>: æœ€å¤§é‡è¯•3æ¬¡ï¼ŒæŒ‡æ•°é€€é¿å»¶è¿Ÿï¼ˆ1s, 2s, 3sï¼‰</li>
<li><strong>è¶…æ—¶æ§åˆ¶</strong>: æ ¹æ®ä»»åŠ¡ç±»å‹é…ç½®è¶…æ—¶æ—¶é—´ï¼ˆåˆ†ç±»30sï¼Œç¼–è¾‘60sï¼‰</li>
</ul>
<p><strong>æ ¸å¿ƒç±»</strong>:</p>
<pre><code></code></pre>
<h3>1.3 Providerå±‚ (Provider Layer)</h3>
<p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>app/services/llm/providers.py</code></p>
<p><strong>æ ¸å¿ƒèŒè´£</strong>:</p>
<ul>
<li>å®ç°ä¸åŒæä¾›å•†çš„APIè°ƒç”¨é€»è¾‘</li>
<li>ç»Ÿä¸€æ¥å£æŠ½è±¡ï¼Œå±è”½æä¾›å•†å·®å¼‚</li>
<li>æä¾›å•†ç‰¹å®šçš„é”™è¯¯ç è½¬æ¢</li>
</ul>
<p><strong>æ”¯æŒçš„æä¾›å•†</strong>:</p>
<p>1. <strong>AliyunProvider</strong> (é˜¿é‡Œäº‘é€šä¹‰åƒé—®)</p>
<ul>
<li>åˆ†ç±»æ¨¡å‹: <code>qwen-vl-plus</code></li>
<li>ç¼–è¾‘æ¨¡å‹: <code>qwen-image-edit</code></li>
<li>æ–‡æœ¬ç”Ÿæˆ: <code>qwen-turbo</code>, <code>qwen-plus</code>, <code>qwen-max</code></li>
<li>API: DashScope SDK</li>
</ul>
<p>2. <strong>OpenAIProvider</strong></p>
<ul>
<li>åˆ†ç±»æ¨¡å‹: <code>gpt-4-vision-preview</code>, <code>gpt-4o</code></li>
<li>ç¼–è¾‘æ¨¡å‹: ä¸æ”¯æŒ</li>
<li>æ–‡æœ¬ç”Ÿæˆ: <code>gpt-4</code>, <code>gpt-3.5-turbo</code></li>
<li>API: OpenAI SDK</li>
</ul>
<p>3. <strong>ClaudeProvider</strong></p>
<ul>
<li>åˆ†ç±»æ¨¡å‹: <code>claude-3-opus</code>, <code>claude-3-sonnet</code>, <code>claude-3-haiku</code></li>
<li>ç¼–è¾‘æ¨¡å‹: ä¸æ”¯æŒ</li>
<li>æ–‡æœ¬ç”Ÿæˆ: <code>claude-3-opus</code>, <code>claude-3-sonnet</code></li>
<li>API: Anthropic SDK</li>
</ul>
<p>4. <strong>DeepseekProvider</strong></p>
<ul>
<li>åˆ†ç±»æ¨¡å‹: ä¸æ”¯æŒ</li>
<li>ç¼–è¾‘æ¨¡å‹: ä¸æ”¯æŒ</li>
<li>æ–‡æœ¬ç”Ÿæˆ: <code>deepseek-chat</code></li>
<li>API: å…¼å®¹OpenAIæ ¼å¼</li>
</ul>
<p><strong>æ ¸å¿ƒæ¥å£</strong>:</p>
<pre><code></code></pre>
<h3>1.4 ä¸šåŠ¡å±‚ (Business Layer)</h3>
<p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>app/services/llm/llm_service.py</code></p>
<p><strong>æ ¸å¿ƒèŒè´£</strong>:</p>
<ul>
<li>ç»Ÿä¸€çš„ä¸šåŠ¡æ¥å£å…¥å£</li>
<li>è‡ªåŠ¨é€‰æ‹©æä¾›å•†å’Œæ¨¡å‹</li>
<li>é›†æˆç»Ÿä¸€ç¼“å­˜æ¶æ„</li>
<li>å“åº”è§£æå’Œæ ¼å¼åŒ–</li>
<li>ä»»åŠ¡ç±»å‹è·¯ç”±ï¼ˆåˆ†ç±»/ç¼–è¾‘ï¼‰</li>
</ul>
<p><strong>æ ¸å¿ƒæ–¹æ³•</strong>:</p>
<pre><code></code></pre>
<p><strong>ä¸šåŠ¡åŠŸèƒ½è¯´æ˜</strong>:</p>
<ul>
<li><code>LLMService</code> æ˜¯å”¯ä¸€çš„ä¸šåŠ¡æœåŠ¡å±‚ï¼Œæä¾›5å¤§æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼š</li>
</ul>
<p>1. <strong>å›¾åƒåˆ†ç±»</strong> (<code>classify_image</code>) - å†…å®¹åˆ†ç±»ï¼ˆ9ç±»ï¼‰+ èƒŒæ™¯é¢œè‰²è¯†åˆ«</p>
<p>2. <strong>é¢œè‰²åˆ†ç±»</strong> (<code>classify_color</code>) - ä¸“é—¨è¯†åˆ«ç…§ç‰‡ä¸»è‰²è°ƒ/èƒŒæ™¯é¢œè‰²</p>
<p>3. <strong>æ„å›¾åˆ†æ</strong> (<code>analyze_composition</code>) - åˆ†æç…§ç‰‡æ„å›¾æ–¹å¼ï¼Œç»™å‡ºä¸“ä¸šç‚¹è¯„å’Œå»ºè®®</p>
<p>4. <strong>å›¾åƒç¼–è¾‘</strong> (<code>edit_image</code>) - å›¾åƒå¢å¼ºã€èƒŒæ™¯æ›¿æ¢ã€é£æ ¼è½¬æ¢ç­‰</p>
<p>5. <strong>æ–‡æœ¬ç”Ÿæˆ</strong> (<code>generate_text</code>) - åŸºäºæ–‡æœ¬æç¤ºè¯ç”Ÿæˆæ–‡æœ¬å†…å®¹</p>
<ul>
<li>APIè·¯ç”±å±‚è°ƒç”¨ <code>LLMService</code> çš„ç›¸åº”æ–¹æ³•ï¼Œå®ƒä»¬ä¸æ˜¯å¹³çº§å…³ç³»</li>
<li>æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½éƒ½é›†æˆç»Ÿä¸€ç¼“å­˜æ¶æ„ï¼Œæ”¯æŒè‡ªå®šä¹‰prompt</li>
</ul>
<p><strong>æ¨¡å‹é…ç½®ç®¡ç†</strong> (<code>app/services/llm/model_config.py</code>):</p>
<ul>
<li>ä»»åŠ¡ç±»å‹æšä¸¾: <code>CLASSIFICATION</code>, <code>IMAGE_EDIT</code>, <code>TEXT_GENERATION</code></li>
<li>æä¾›å•†æšä¸¾: <code>ALIYUN</code>, <code>OPENAI</code>, <code>CLAUDE</code>, <code>DEEPSEEK</code></li>
<li>è‡ªåŠ¨æ¨¡å‹é€‰æ‹©: æ ¹æ®æä¾›å•†å’Œä»»åŠ¡ç±»å‹è‡ªåŠ¨é€‰æ‹©é»˜è®¤æ¨¡å‹</li>
<li>æ¨¡å‹éªŒè¯: éªŒè¯æ¨¡å‹æ˜¯å¦æ”¯æŒæŒ‡å®šä»»åŠ¡ç±»å‹</li>
</ul>
<h2>äºŒã€ç»Ÿä¸€ç¼“å­˜æ¶æ„</h2>
<h3>2.1 ç¼“å­˜è®¾è®¡</h3>
<p><strong>æ–‡ä»¶ä½ç½®</strong>: <code>app/services/unified_llm_cache.py</code></p>
<p><strong>æ•°æ®åº“è¡¨</strong>: <code>llm_inference_cache_v2</code></p>
<p><strong>ç¼“å­˜é”®è®¾è®¡</strong>:</p>
<ul>
<li><strong>ä¸»é”®</strong>: <code>(prompt_hash, image_hash)</code> ç»„åˆ</li>
<li><code>prompt_hash</code>: SHA-256(prompt) - 64å­—ç¬¦</li>
<li><code>image_hash</code>: SHA-256(image_bytes) - 64å­—ç¬¦</li>
</ul>
<p><strong>ç¼“å­˜å€¼ç»“æ„</strong> (JSONæ ¼å¼):</p>
<pre><code></code></pre>
<p><strong>æ ¸å¿ƒç‰¹æ€§</strong>:</p>
<p>1. <strong>å¤šæ¨¡å‹ç»“æœé›†åˆ</strong>: ä¸€ä¸ªå›¾ç‰‡+æç¤ºè¯ç»„åˆå¯ä»¥ç¼“å­˜å¤šä¸ªæ¨¡å‹çš„ç»“æœ</p>
<p>2. <strong>æ¨¡å‹é”®æ ¼å¼</strong>: <code>provider:model_id</code> æˆ– <code>provider:model_id:version</code></p>
<p>3. <strong>å‘½ä¸­è®¡æ•°</strong>: è‡ªåŠ¨ç»Ÿè®¡ç¼“å­˜å‘½ä¸­æ¬¡æ•°</p>
<p>4. <strong>æ‰¹é‡æŸ¥è¯¢</strong>: æ”¯æŒæ‰¹é‡æŸ¥è¯¢å¤šä¸ªå›¾ç‰‡çš„ç¼“å­˜ç»“æœ</p>
<p><strong>æ ¸å¿ƒæ–¹æ³•</strong>:</p>
<pre><code></code></pre>
<h3>2.2 ç¼“å­˜æµç¨‹</h3>
<p><strong>åˆ†ç±»æœåŠ¡ç¼“å­˜æµç¨‹</strong>:</p>
<pre><code></code></pre>
<p><strong>æ‰¹é‡ç¼“å­˜æŸ¥è¯¢æµç¨‹</strong>:</p>
<pre><code></code></pre>
<h2>ä¸‰ã€ä¸šåŠ¡å±‚å›¾åƒæ™ºèƒ½æ¥å£</h2>
<p>LLMService æä¾›5å¤§æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½é›†æˆç»Ÿä¸€ç¼“å­˜æ¶æ„ï¼š</p>
<h3>3.1 å›¾åƒåˆ†ç±» (classify_image)</h3>
<p><strong>åŠŸèƒ½</strong>: å›¾åƒå†…å®¹åˆ†ç±» + èƒŒæ™¯é¢œè‰²è¯†åˆ«</p>
<p><strong>APIè·¯å¾„</strong>: <code>/api/v1/classify/*</code></p>
<p><strong>æ¥å£åˆ—è¡¨</strong>:</p>
<p>1. <strong>å•ä¸ªç¼“å­˜æŸ¥è¯¢</strong></p>
<ul>
<li><code>POST /api/v1/classify/check-cache</code></li>
<li>è¯·æ±‚: <code>{image_hash: str}</code></li>
<li>å“åº”: <code>{cached: bool, data: ClassificationData}</code></li>
</ul>
<p>2. <strong>æ‰¹é‡ç¼“å­˜æŸ¥è¯¢</strong></p>
<ul>
<li><code>POST /api/v1/classify/batch-check-cache</code></li>
<li>è¯·æ±‚: <code>{image_hashes: List[str]}</code></li>
<li>å“åº”: <code>{items: List[CacheItem], cached_count: int}</code></li>
</ul>
<p>3. <strong>å•ä¸ªå›¾ç‰‡åˆ†ç±»</strong></p>
<ul>
<li><code>POST /api/v1/classify</code></li>
<li>è¯·æ±‚: <code>multipart/form-data</code> (imageæ–‡ä»¶)</li>
<li>å“åº”: <code>{category, confidence, description, background_color}</code></li>
</ul>
<p>4. <strong>æ‰¹é‡å›¾ç‰‡åˆ†ç±»</strong></p>
<ul>
<li><code>POST /api/v1/classify/batch</code></li>
<li>è¯·æ±‚: <code>multipart/form-data</code> (imagesåˆ—è¡¨ï¼Œæœ€å¤š20å¼ )</li>
<li>å“åº”: <code>{results: List[ClassificationData]}</code></li>
</ul>
<p><strong>åˆ†ç±»ç±»åˆ«</strong> (9ç±»):</p>
<ul>
<li><code>social_activities</code> - ç¤¾äº¤æ´»åŠ¨</li>
<li><code>pets</code> - å® ç‰©èŒç…§</li>
<li><code>single_person</code> - å•äººç…§ç‰‡</li>
<li><code>foods</code> - ç¾é£Ÿè®°å½•</li>
<li><code>travel_scenery</code> - æ—…è¡Œé£æ™¯</li>
<li><code>screenshot</code> - æ‰‹æœºæˆªå›¾</li>
<li><code>idcard</code> - è¯ä»¶ç…§</li>
<li><code>qrcode</code> - äºŒç»´ç </li>
<li><code>other</code> - å…¶å®ƒ</li>
</ul>
<p><strong>æŠ€æœ¯ç‰¹æ€§</strong>:</p>
<ul>
<li>æ”¯æŒè‡ªå®šä¹‰promptï¼ˆå¯é€‰ï¼‰</li>
<li>è‡ªåŠ¨ç¼“å­˜ç®¡ç†</li>
<li>äºŒç»´ç å¿«é€Ÿæ£€æµ‹ï¼ˆpyzbarï¼‰</li>
<li>æœ¬åœ°æ¨ç†é™çº§ï¼ˆå¯é€‰ï¼‰</li>
</ul>
<h3>3.2 é¢œè‰²åˆ†ç±» (classify_color)</h3>
<p><strong>åŠŸèƒ½</strong>: ä¸“é—¨è¯†åˆ«ç…§ç‰‡ä¸»è‰²è°ƒ/èƒŒæ™¯é¢œè‰²</p>
<p><strong>æ–¹æ³•</strong>: <code>llm_service.classify_color()</code></p>
<p><strong>è¿”å›ç»“æœ</strong>:</p>
<pre><code></code></pre>
<p><strong>æŠ€æœ¯ç‰¹æ€§</strong>:</p>
<ul>
<li>ä½¿ç”¨ä¸“é—¨çš„é¢œè‰²åˆ†ç±»prompt</li>
<li>é›†æˆç»Ÿä¸€ç¼“å­˜æ¶æ„</li>
<li>æ”¯æŒè‡ªå®šä¹‰prompt</li>
<li>è¿”å›JSONæ ¼å¼çš„é¢œè‰²ä¿¡æ¯</li>
</ul>
<p><strong>èƒŒæ™¯é¢œè‰²ç±»åˆ«</strong> (10ç§):</p>
<ul>
<li>æ©™è‰²ã€è“è‰²ã€çº¢è‰²ã€ç»¿è‰²ã€ç´«è‰²</li>
<li>ç²‰è‰²ã€é»„è‰²ã€ç°è‰²ã€é»‘è‰²ã€ç™½è‰²</li>
</ul>
<h3>3.3 æ„å›¾åˆ†æ (analyze_composition)</h3>
<p><strong>åŠŸèƒ½</strong>: åˆ†æç…§ç‰‡æ„å›¾æ–¹å¼ï¼Œç»™å‡ºä¸“ä¸šç‚¹è¯„å’Œå»ºè®®</p>
<p><strong>æ–¹æ³•</strong>: <code>llm_service.analyze_composition()</code></p>
<p><strong>è¿”å›ç»“æœ</strong>:</p>
<pre><code></code></pre>
<p><strong>åˆ†æç»´åº¦</strong>:</p>
<ul>
<li><code>composition_type</code> - æ„å›¾ç±»å‹ï¼ˆå¦‚ï¼šä¸‰åˆ†æ³•ã€ä¸­å¿ƒæ„å›¾ã€å¯¹ç§°æ„å›¾ç­‰ï¼‰</li>
<li><code>subject_position</code> - ä¸»ä½“ä½ç½®</li>
<li><code>visual_balance</code> - è§†è§‰å¹³è¡¡</li>
<li><code>spatial_layout</code> - ç©ºé—´å¸ƒå±€</li>
<li><code>lines_and_shapes</code> - çº¿æ¡ä¸å½¢çŠ¶</li>
<li><code>strengths</code> - ä¼˜ç‚¹åˆ—è¡¨</li>
<li><code>suggestions</code> - æ”¹è¿›å»ºè®®</li>
<li><code>score</code> - æ„å›¾è¯„åˆ†ï¼ˆ0-10åˆ†ï¼‰</li>
<li><code>detailed_analysis</code> - è¯¦ç»†åˆ†ææ–‡æœ¬</li>
</ul>
<p><strong>æŠ€æœ¯ç‰¹æ€§</strong>:</p>
<ul>
<li>ä½¿ç”¨ä¸“é—¨çš„æ„å›¾åˆ†æprompt</li>
<li>é›†æˆç»Ÿä¸€ç¼“å­˜æ¶æ„</li>
<li>æ”¯æŒè‡ªå®šä¹‰prompt</li>
<li>è¿”å›ä¸“ä¸šçš„æ„å›¾åˆ†æJSON</li>
</ul>
<h3>3.4 å›¾åƒç¼–è¾‘ (edit_image)</h3>
<p><strong>åŠŸèƒ½</strong>: å›¾åƒå¢å¼ºã€èƒŒæ™¯æ›¿æ¢ã€é£æ ¼è½¬æ¢ç­‰</p>
<h3>3.2 å›¾åƒç¼–è¾‘æ¥å£</h3>
<p><strong>APIè·¯å¾„</strong>: <code>/api/v2/image-edit/*</code></p>
<p><strong>æ¥å£åˆ—è¡¨</strong>:</p>
<p>1. <strong>æ‰¹é‡å›¾åƒç¼–è¾‘ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰</strong></p>
<ul>
<li><code>POST /api/v2/image-edit/batch</code></li>
<li>è¯·æ±‚: <code>multipart/form-data</code> (imagesåˆ—è¡¨, prompt, edit_type)</li>
<li>å“åº”: <code>{task_id: str, status: "pending"}</code></li>
</ul>
<p>2. <strong>æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€</strong></p>
<ul>
<li><code>GET /api/v2/image-edit/task/{task_id}</code></li>
<li>å“åº”: <code>{status, progress, results: List[ImageEditResult]}</code></li>
</ul>
<p><strong>ç¼–è¾‘ç±»å‹</strong> (<code>edit_type</code>):</p>
<ul>
<li><code>enhance</code> - å›¾åƒå¢å¼ºï¼ˆé»˜è®¤ï¼‰</li>
<li><code>remove_background</code> - ç§»é™¤èƒŒæ™¯</li>
<li><code>change_background</code> - æ›´æ¢èƒŒæ™¯</li>
<li><code>style_transfer</code> - é£æ ¼è½¬æ¢</li>
</ul>
<p><strong>æŠ€æœ¯ç‰¹æ€§</strong>:</p>
<ul>
<li>å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆåå°å¤„ç†å¤§é‡å›¾ç‰‡ï¼‰</li>
<li>ä»»åŠ¡çŠ¶æ€è·Ÿè¸ªï¼ˆpending/processing/completed/failedï¼‰</li>
<li>ä¸ƒç‰›äº‘OSSå­˜å‚¨ï¼ˆç¼–è¾‘åçš„å›¾ç‰‡ï¼‰</li>
<li>ç§¯åˆ†æ‰£å‡ï¼ˆæ¯æ¬¡ç¼–è¾‘æ‰£å‡ç§¯åˆ†ï¼‰</li>
<li>ç»Ÿä¸€ç¼“å­˜é›†æˆ</li>
</ul>
<p><strong>ä¸šåŠ¡æµç¨‹</strong>:</p>
<pre><code></code></pre>
<h3>3.5 æ–‡æœ¬ç”Ÿæˆ (generate_text)</h3>
<p><strong>åŠŸèƒ½</strong>: åŸºäºæ–‡æœ¬æç¤ºè¯ç”Ÿæˆæ–‡æœ¬å†…å®¹</p>
<p><strong>æ–¹æ³•</strong>: <code>llm_service.generate_text()</code></p>
<p><strong>å‚æ•°</strong>:</p>
<ul>
<li><code>prompt</code> - ç”¨æˆ·æç¤ºè¯ï¼ˆå¿…éœ€ï¼‰</li>
<li><code>system_prompt</code> - ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰</li>
<li><code>max_tokens</code> - æœ€å¤§tokenæ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤2000ï¼‰</li>
<li><code>temperature</code> - æ¸©åº¦å‚æ•°ï¼ˆ0-2ï¼Œé»˜è®¤0.7ï¼‰</li>
</ul>
<p><strong>è¿”å›ç»“æœ</strong>:</p>
<pre><code></code></pre>
<p><strong>æŠ€æœ¯ç‰¹æ€§</strong>:</p>
<ul>
<li>é»˜è®¤ä½¿ç”¨Deepseekæ¨¡å‹ï¼ˆå¦‚æœé…ç½®äº†DEEPSEEK_API_KEYï¼‰</li>
<li>æ”¯æŒå…¶ä»–æä¾›å•†çš„æ–‡æœ¬ç”Ÿæˆæ¨¡å‹ï¼ˆOpenAIã€Claudeã€é˜¿é‡Œäº‘ï¼‰</li>
<li><strong>ä¸ä½¿ç”¨ç¼“å­˜</strong>ï¼ˆæ–‡æœ¬ç”Ÿæˆæ¯æ¬¡éƒ½æ˜¯æ–°å†…å®¹ï¼‰</li>
<li>æ”¯æŒè‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯</li>
<li>æ”¯æŒæ¸©åº¦å‚æ•°æ§åˆ¶ç”Ÿæˆéšæœºæ€§</li>
</ul>
<p><strong>æ”¯æŒçš„æ¨¡å‹</strong>:</p>
<ul>
<li><strong>Deepseek</strong>: <code>deepseek-chat</code></li>
<li><strong>é˜¿é‡Œäº‘</strong>: <code>qwen-turbo</code>, <code>qwen-plus</code>, <code>qwen-max</code></li>
<li><strong>OpenAI</strong>: <code>gpt-4</code>, <code>gpt-3.5-turbo</code></li>
<li><strong>Claude</strong>: <code>claude-3-opus</code>, <code>claude-3-sonnet</code></li>
</ul>
<h2>å››ã€ä½ç½®æœåŠ¡</h2>
<h3>4.1 æ¶æ„æ¦‚è§ˆ</h3>
<p><strong>APIè·¯å¾„</strong>: <code>/api/v2/location/*</code></p>
<p><strong>æ ¸å¿ƒæ–‡ä»¶</strong>:</p>
<ul>
<li><code>app/api/location_v2.py</code> - APIè·¯ç”±å±‚</li>
<li><code>app/services/geocoding_client.py</code> - åœ°ç†ç¼–ç å®¢æˆ·ç«¯</li>
</ul>
<p><strong>æ•°æ®åº“è¡¨</strong>:</p>
<ul>
<li><code>global_cities_v2</code> - åŸå¸‚æ•°æ®è¡¨ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰</li>
<li><code>city_name_mapping</code> - ä¸­è‹±æ–‡åç§°æ˜ å°„è¡¨</li>
<li><code>api_call_stats</code> - APIè°ƒç”¨ç»Ÿè®¡è¡¨</li>
</ul>
<h3>4.2 ä¸šåŠ¡æµç¨‹</h3>
<p><strong>æŸ¥è¯¢æµç¨‹</strong>:</p>
<pre><code></code></pre>
<h3>4.3 æŠ€æœ¯æ ˆ</h3>
<img src="/assets/diary/layeredarch/tech-arch.png" alt="åç«¯æŠ€æœ¯æ ˆ" style="max-width: 100%; height: auto; margin: 20px 0; border-radius: 8px;">
<p><strong>åç«¯æ¡†æ¶</strong>:</p>
<ul>
<li>FastAPI - å¼‚æ­¥Webæ¡†æ¶</li>
<li>uvicorn - ASGIæœåŠ¡å™¨ï¼ˆç”¨äºè¿è¡ŒFastAPIåº”ç”¨ï¼‰</li>
<li>aiomysql - å¼‚æ­¥MySQLé©±åŠ¨</li>
<li>httpx - å¼‚æ­¥HTTPå®¢æˆ·ç«¯</li>
</ul>
<p><strong>æ•°æ®åº“</strong>:</p>
<ul>
<li>MySQL 8.0 - å­˜å‚¨åŸå¸‚æ•°æ®å’Œç¼“å­˜</li>
<li>è¿æ¥æ± ç®¡ç†ï¼ˆpool_size=10, max_overflow=5ï¼‰</li>
</ul>
<p><strong>åœ°ç†è®¡ç®—</strong>:</p>
<ul>
<li>Haversineå…¬å¼ - è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»</li>
<li>åæ ‡èŒƒå›´åˆ¤æ–­ - åˆ¤æ–­æ˜¯å¦åœ¨ä¸­å›½å¢ƒå†…</li>
</ul>
<h3>4.4 å¤–éƒ¨æ¥å£</h3>
<p><strong>1. é«˜å¾·åœ°å›¾API</strong> (ä¸­å›½åæ ‡)</p>
<ul>
<li><strong>æ¥å£</strong>: <code>https://restapi.amap.com/v3/geocode/regeo</code></li>
<li><strong>ç”¨é€”</strong>: ä¸­å›½å¢ƒå†…åæ ‡çš„é€†åœ°ç†ç¼–ç </li>
<li><strong>é¢‘ç‡é™åˆ¶</strong>: 30æ¬¡/ç§’ï¼ˆä½¿ç”¨Semaphoreé™åˆ¶ä¸º25æ¬¡/ç§’ï¼‰</li>
<li><strong>è¿”å›å­—æ®µ</strong>:</li>
<li><code>formatted_address</code> - æ ¼å¼åŒ–åœ°å€</li>
<li><code>addressComponent</code> - åœ°å€ç»„ä»¶ï¼ˆçœå¸‚åŒºï¼‰</li>
<li><code>adcode</code> - è¡Œæ”¿åŒºåˆ’ä»£ç </li>
<li><code>citycode</code> - åŸå¸‚ä»£ç </li>
</ul>
<p><strong>2. Nominatim API</strong> (æµ·å¤–åæ ‡)</p>
<ul>
<li><strong>æ¥å£</strong>: <code>https://www.xintuzhaopian.com/reverse</code> (Cloudflare Workerä»£ç†)</li>
<li><strong>ç”¨é€”</strong>: æµ·å¤–åæ ‡çš„é€†åœ°ç†ç¼–ç </li>
<li><strong>é¢‘ç‡é™åˆ¶</strong>: 1æ¬¡/ç§’ï¼ˆä½¿ç”¨Lockæ§åˆ¶ï¼‰</li>
<li><strong>è¿”å›å­—æ®µ</strong>:</li>
<li><code>display_name</code> - æ˜¾ç¤ºåç§°</li>
<li><code>address</code> - åœ°å€ç»„ä»¶</li>
<li><code>country_code</code> - å›½å®¶ä»£ç </li>
<li><code>lat</code>, <code>lon</code> - åæ ‡</li>
</ul>
<p><strong>3. GeoNamesæ•°æ®åº“</strong> (é™çº§æŸ¥è¯¢)</p>
<ul>
<li><strong>æ•°æ®æº</strong>: <code>global_cities_v2</code> è¡¨</li>
<li><strong>ç”¨é€”</strong>: APIå¤±è´¥æ—¶çš„é™çº§æŸ¥è¯¢</li>
<li><strong>æŸ¥è¯¢æ–¹å¼</strong>: ä½¿ç”¨Haversineå…¬å¼æŸ¥æ‰¾æœ€è¿‘åŸå¸‚</li>
</ul>
<h3>4.5 æ•°æ®è§„èŒƒåŒ–</h3>
<p><strong>éªŒè¯å’Œè§„èŒƒåŒ–å‡½æ•°</strong>: <code>validate_and_normalize_location()</code></p>
<p><strong>è§„èŒƒåŒ–è§„åˆ™</strong>:</p>
<p>1. <strong>name_en å’Œ name_zh</strong>:</p>
<ul>
<li>å¦‚æœ <code>name_zh</code> æœ‰å€¼ï¼Œä½¿ç”¨ <code>name_zh</code> å¡«å…… <code>name_en</code></li>
<li>å¦‚æœ <code>name_zh</code> ä¸ºç©ºä½† <code>name_en</code> æœ‰å€¼ï¼Œä½¿ç”¨ <code>name_en</code> å¡«å…… <code>name_zh</code></li>
<li>å¦‚æœä¸¤è€…éƒ½ä¸ºç©ºï¼Œè®¾ç½® <code>name_en="Unknown"</code>, <code>name_zh="æœªçŸ¥ä½ç½®"</code></li>
</ul>
<p>2. <strong>country_code</strong>:</p>
<ul>
<li>ä½¿ç”¨å®é™…è¿”å›çš„å€¼</li>
<li>å¦‚æœæœªè¿”å›ï¼Œæ•´ä¸ªä½ç½®ä¿¡æ¯å›é€€åˆ° "unknown"</li>
</ul>
<p>3. <strong>province</strong>:</p>
<ul>
<li>ä¸­å›½ä½ç½®: å¦‚æœ <code>province</code> ç¼ºå¤±ï¼Œæ•°æ®è§†ä¸ºé”™è¯¯ï¼Œå›é€€åˆ° "unknown"</li>
<li>æµ·å¤–ä½ç½®: å¯ä»¥ä½¿ç”¨è¾ƒä½çº§åˆ«çš„è¡Œæ”¿åŒºåˆ’ä½œä¸ºæ›¿ä»£ï¼ˆstate/regionï¼‰</li>
</ul>
<p>4. <strong>æ•´ä½“éªŒè¯</strong>:</p>
<ul>
<li>å¦‚æœ <code>name_en</code>ã€<code>province</code>ã€<code>country_code</code> ä»»ä¸€æ— æ³•ç¡®å®šï¼Œæ•´ä¸ªä½ç½®è§†ä¸º "unknown"</li>
</ul>
<p><strong>æœªçŸ¥ä½ç½®åˆ›å»º</strong>: <code>create_unknown_location()</code></p>
<pre><code></code></pre>
<h3>4.6 APIæ¥å£</h3>
<p><strong>1. æ‰¹é‡æŸ¥è¯¢æœ€è¿‘åŸå¸‚</strong></p>
<ul>
<li><code>POST /api/v2/location/nearest-cities</code></li>
<li>è¯·æ±‚: <code>{coordinates: List[Coordinate]}</code></li>
<li>å“åº”: <code>{results: List[CityQueryResult], success_count, failed_count}</code></li>
<li>é™åˆ¶: æœ€å¤š500ä¸ªåæ ‡</li>
</ul>
<p><strong>2. ç»Ÿè®¡ä¿¡æ¯</strong></p>
<ul>
<li><code>GET /api/v2/location/stats</code></li>
<li>å“åº”: <code>{total_cities, cities_with_chinese, api_calls_today, ...}</code></li>
</ul>
<p><strong>å“åº”æ¨¡å‹</strong>:</p>
<pre><code></code></pre>
<h3>4.7 æ€§èƒ½ä¼˜åŒ–</h3>
<p><strong>å¹¶å‘æ§åˆ¶</strong>:</p>
<ul>
<li>é«˜å¾·API: Semaphore(25) - é™åˆ¶å¹¶å‘è¯·æ±‚æ•°</li>
<li>Nominatim API: Lock + æ—¶é—´æ§åˆ¶ - é™åˆ¶è¯·æ±‚é¢‘ç‡ï¼ˆ1æ¬¡/ç§’ï¼‰</li>
</ul>
<p><strong>æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–</strong>:</p>
<ul>
<li>ä½¿ç”¨ <code>asyncio.gather()</code> å¹¶è¡Œå¤„ç†å¤šä¸ªåæ ‡</li>
<li>æœ¬åœ°æ•°æ®åº“æ‰¹é‡æŸ¥è¯¢ï¼ˆINæŸ¥è¯¢ï¼‰</li>
<li>å¤–éƒ¨APIå¹¶å‘è°ƒç”¨ï¼ˆå—é¢‘ç‡é™åˆ¶æ§åˆ¶ï¼‰</li>
</ul>
<p><strong>ç¼“å­˜ç­–ç•¥</strong>:</p>
<ul>
<li>æœ¬åœ°æ•°æ®åº“ç¼“å­˜ï¼ˆ3kmèŒƒå›´å†…ï¼‰</li>
<li>APIç»“æœè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“</li>
<li>å‡å°‘é‡å¤APIè°ƒç”¨</li>
</ul>
<p><strong>æ—¥å¿—è®°å½•</strong>:</p>
<ul>
<li>APIè°ƒç”¨ç»Ÿè®¡ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰</li>
<li>æŸ¥è¯¢è€—æ—¶ç»Ÿè®¡</li>
<li>æ•°æ®æ¥æºè¿½è¸ªï¼ˆlocal/gaode/nominatim/fallbackï¼‰</li>
</ul>
<h2>äº”ã€æŠ€æœ¯äº®ç‚¹æ€»ç»“</h2>
<h3>5.1 æ¶æ„è®¾è®¡</h3>
<ul>
<li>âœ… ä¸‰å±‚æ¶æ„æ¸…æ™°åˆ†ç¦»ï¼ˆåŸºç¡€æœåŠ¡/Provider/ä¸šåŠ¡å±‚ï¼‰</li>
<li>âœ… ç»Ÿä¸€çš„æ¥å£æŠ½è±¡ï¼Œæ˜“äºæ‰©å±•æ–°æä¾›å•†</li>
<li>âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶</li>
</ul>
<h3>5.2 ç¼“å­˜æ¶æ„</h3>
<ul>
<li>âœ… å¤šæ¨¡å‹ç»“æœé›†åˆå­˜å‚¨</li>
<li>âœ… æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–</li>
<li>âœ… è‡ªåŠ¨å‘½ä¸­è®¡æ•°</li>
</ul>
<h3>5.3 ä½ç½®æœåŠ¡</h3>
<ul>
<li>âœ… æ™ºèƒ½é™çº§ç­–ç•¥ï¼ˆæœ¬åœ°DB â†’ å¤–éƒ¨API â†’ v1æŸ¥è¯¢ï¼‰</li>
<li>âœ… æ•°æ®è§„èŒƒåŒ–ä¿è¯æ•°æ®è´¨é‡</li>
<li>âœ… å¹¶å‘æ§åˆ¶å’Œé¢‘ç‡é™åˆ¶</li>
<li>âœ… ä¸­å›½/æµ·å¤–åæ ‡è‡ªåŠ¨è·¯ç”±</li>
</ul>
<h3>5.4 æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>âœ… å…¨å¼‚æ­¥æ¶æ„ï¼ˆFastAPI + aiomysql + httpxï¼‰</li>
<li>âœ… è¿æ¥æ± ç®¡ç†</li>
<li>âœ… æ‰¹é‡å¤„ç†æ”¯æŒ</li>
<li>âœ… æ™ºèƒ½ç¼“å­˜ç­–ç•¥</li>
</ul>
<h3>5.5 å¯æ‰©å±•æ€§</h3>
<ul>
<li>âœ… æ˜“äºæ·»åŠ æ–°çš„å¤§æ¨¡å‹æä¾›å•†</li>
<li>âœ… æ˜“äºæ·»åŠ æ–°çš„ä»»åŠ¡ç±»å‹</li>
<li>âœ… é…ç½®åŒ–çš„æ¨¡å‹é€‰æ‹©</li>
<li>âœ… ç»Ÿä¸€çš„ç¼“å­˜æ¥å£</li>
</ul>
<h2>å…­ã€æ•°æ®åº“è®¾è®¡</h2>
<h3>6.1 å¤§æ¨¡å‹ç¼“å­˜è¡¨</h3>
<p><strong>è¡¨å</strong>: <code>llm_inference_cache_v2</code></p>
<p><strong>å­—æ®µ</strong>:</p>
<ul>
<li><code>prompt_hash</code> VARCHAR(64) - æç¤ºè¯å“ˆå¸Œï¼ˆä¸»é”®ï¼‰</li>
<li><code>image_hash</code> VARCHAR(64) - å›¾ç‰‡å“ˆå¸Œï¼ˆä¸»é”®ï¼‰</li>
<li><code>model_results</code> JSON - å¤šæ¨¡å‹ç»“æœé›†åˆ</li>
<li><code>hit_count</code> INT - å‘½ä¸­æ¬¡æ•°</li>
<li><code>created_at</code> DATETIME - åˆ›å»ºæ—¶é—´</li>
<li><code>last_hit_at</code> DATETIME - æœ€åå‘½ä¸­æ—¶é—´</li>
</ul>
<p><strong>ç´¢å¼•</strong>:</p>
<ul>
<li>PRIMARY KEY (<code>prompt_hash</code>, <code>image_hash</code>)</li>
<li>INDEX <code>idx_image_hash</code> (<code>image_hash</code>)</li>
<li>INDEX <code>idx_last_hit_at</code> (<code>last_hit_at</code>)</li>
</ul>
<h3>6.2 ä½ç½®æ•°æ®è¡¨</h3>
<p><strong>è¡¨å</strong>: <code>global_cities_v2</code></p>
<p><strong>å­—æ®µ</strong>:</p>
<ul>
<li><code>id</code> INT - ä¸»é”®</li>
<li><code>name_en</code> VARCHAR(255) - è‹±æ–‡åç§°</li>
<li><code>latitude</code> DECIMAL(10,7) - çº¬åº¦</li>
<li><code>longitude</code> DECIMAL(10,7) - ç»åº¦</li>
<li><code>country_code</code> VARCHAR(2) - å›½å®¶ä»£ç </li>
<li><code>province</code> VARCHAR(255) - çœä»½/å·</li>
<li><code>city</code> VARCHAR(255) - åŸå¸‚</li>
<li><code>district</code> VARCHAR(255) - åŒºå¿</li>
<li><code>data_source</code> VARCHAR(50) - æ•°æ®æ¥æº</li>
<li><code>api_adcode</code> VARCHAR(20) - é«˜å¾·è¡Œæ”¿åŒºåˆ’ä»£ç </li>
<li><code>api_city_id</code> VARCHAR(50) - APIåŸå¸‚ID</li>
</ul>
<p><strong>ç´¢å¼•</strong>:</p>
<ul>
<li>PRIMARY KEY (<code>id</code>)</li>
<li>INDEX <code>idx_location</code> (<code>latitude</code>, <code>longitude</code>)</li>
<li>INDEX <code>idx_country</code> (<code>country_code</code>)</li>
</ul>
<p><strong>è¡¨å</strong>: <code>city_name_mapping</code></p>
<p><strong>å­—æ®µ</strong>:</p>
<ul>
<li><code>city_id</code> INT - åŸå¸‚IDï¼ˆå¤–é”®ï¼‰</li>
<li><code>name_zh</code> VARCHAR(255) - ä¸­æ–‡åç§°</li>
<li><code>name_en</code> VARCHAR(255) - è‹±æ–‡åç§°</li>
</ul>
<p><strong>ç´¢å¼•</strong>:</p>
<ul>
<li>PRIMARY KEY (<code>city_id</code>)</li>
<li>INDEX <code>idx_name_zh</code> (<code>name_zh</code>)</li>
</ul>
<h2>ä¸ƒã€é…ç½®ç®¡ç†</h2>
<h3>7.1 ç¯å¢ƒå˜é‡é…ç½®</h3>
<p><strong>å¤§æ¨¡å‹é…ç½®</strong> (<code>.env</code>):</p>
<pre><code></code></pre>
<p><strong>ä½ç½®æœåŠ¡é…ç½®</strong> (<code>.env</code>):</p>
<pre><code></code></pre>
<p><strong>æ•°æ®åº“é…ç½®</strong> (<code>.env</code>):</p>
<pre><code></code></pre>
<h3>7.2 å¯†é’¥ç®¡ç†</h3>
<p><strong>æ•æ„Ÿä¿¡æ¯</strong> (<code>.env.secrets</code>):</p>
<ul>
<li><code>LLM_API_KEY</code> - å¤§æ¨¡å‹APIå¯†é’¥</li>
<li><code>MYSQL_PASSWORD</code> - æ•°æ®åº“å¯†ç </li>
<li><code>GAODE_API_KEY</code> - é«˜å¾·APIå¯†é’¥</li>
<li><code>DEEPSEEK_API_KEY</code> - Deepseek APIå¯†é’¥ï¼ˆå¦‚ä½¿ç”¨ï¼‰</li>
</ul>
<h2>å…«ã€æ€»ç»“</h2>
<p>V2æ¥å£æŠ€æœ¯æ–¹æ¡ˆå®ç°äº†ï¼š</p>
<p>1. <strong>æ¸…æ™°çš„åˆ†å±‚æ¶æ„</strong> - åŸºç¡€æœåŠ¡å±‚ã€Providerå±‚ã€ä¸šåŠ¡å±‚èŒè´£æ˜ç¡®</p>
<p>2. <strong>ç»Ÿä¸€çš„ç¼“å­˜æ¶æ„</strong> - æ”¯æŒå¤šæ¨¡å‹ç»“æœé›†åˆï¼Œæ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–</p>
<p>3. <strong>å®Œæ•´çš„å›¾åƒæ™ºèƒ½æ¥å£</strong> - åˆ†ç±»å’Œç¼–è¾‘åŠŸèƒ½ï¼Œæ”¯æŒè‡ªå®šä¹‰prompt</p>
<p>4. <strong>æ™ºèƒ½çš„ä½ç½®æœåŠ¡</strong> - å¤šçº§é™çº§ç­–ç•¥ï¼Œæ•°æ®è§„èŒƒåŒ–ï¼Œå¹¶å‘æ§åˆ¶</p>
<p>5. <strong>é«˜æ€§èƒ½å’Œå¯æ‰©å±•æ€§</strong> - å…¨å¼‚æ­¥æ¶æ„ï¼Œè¿æ¥æ± ç®¡ç†ï¼Œæ˜“äºæ‰©å±•</p>
<p>è¯¥æ–¹æ¡ˆä¸ºå›¾åƒæ™ºèƒ½å¤„ç†å’Œä½ç½®æœåŠ¡æä¾›äº†ç¨³å®šã€é«˜æ•ˆã€å¯æ‰©å±•çš„æŠ€æœ¯åŸºç¡€ã€‚</p>
            </div>
            
            <div class="article-content">
                <div class="article-tags">
                    <span class="article-tag">æŠ€æœ¯æ¶æ„</span><span class="article-tag">V2æ¥å£</span><span class="article-tag">å¤§æ¨¡å‹</span><span class="article-tag">ç¼“å­˜æ¶æ„</span><span class="article-tag">ä½ç½®æœåŠ¡</span><span class="article-tag">ç³»ç»Ÿè®¾è®¡</span><span class="article-tag">ç ”å‘ç»éªŒ</span>
                </div>
            </div>
        </article>
        
        
        <div class="related-articles">
            <h2>ç›¸å…³æ–‡ç« </h2>
            <div class="related-articles-grid">
                
                <a href="backend-arch.html" class="related-article-card">
                    <h3>å›¾ç‰‡åˆ†ç±»åç«¯ç³»ç»Ÿ - èŠ¯å›¾ç›¸å†Œåç«¯æŠ€æœ¯æ–¹æ¡ˆ</h3>
                    <p>åŸºäºå¤§æ¨¡å‹æŠ€æœ¯çš„æ™ºèƒ½ç…§ç‰‡åˆ†ç±»æœåŠ¡åç«¯æŠ€æœ¯æ–¹æ¡ˆï¼ŒåŒ…å«æ¶æ„è®¾è®¡ã€æ ¸å¿ƒåŠŸèƒ½ã€æ€§èƒ½ä¼˜åŒ–ç­‰å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆã€‚</p>
                </a>
                <a href="async-arch.html" class="related-article-card">
                    <h3>èŠ¯å›¾ç›¸å†Œï¼šå¼‚æ­¥æ¶æ„ä¸é«˜å¹¶å‘æŠ€æœ¯è¯´æ˜</h3>
                    <p>æ·±å…¥è§£æå›¾ç‰‡åˆ†ç±»åç«¯ç³»ç»Ÿçš„å¼‚æ­¥æ¶æ„è®¾è®¡å’Œé«˜å¹¶å‘æŠ€æœ¯å®ç°ï¼ŒåŒ…å«å¼‚æ­¥è°ƒç”¨æ—¶åºå›¾ã€è¿æ¥æ± ã€å¤šè¿›ç¨‹æ¶æ„ç­‰æ ¸å¿ƒæŠ€æœ¯è¯¦è§£ã€‚</p>
                </a>
                <a href="deploy-arch.html" class="related-article-card">
                    <h3>èŠ¯å›¾ç›¸å†Œï¼šä¸‰å±‚éƒ¨ç½²æ¶æ„å›¾</h3>
                    <p>è¯¦ç»†è¯´æ˜èŠ¯å›¾ç›¸å†Œçš„ä¸‰å±‚éƒ¨ç½²æ¶æ„è®¾è®¡ï¼ŒåŒ…å«å®¢æˆ·ç«¯ã€WEBæœåŠ¡å±‚å’ŒAPPæœåŠ¡å™¨çš„å®Œæ•´æ¶æ„å›¾ï¼Œä»¥åŠäºŒç»´ç ç”Ÿæˆã€æ‰«ç å…³æ³¨ã€ä¼šå‘˜å¼€é€šç­‰å…³é”®ä¸šåŠ¡æµç¨‹æ—¶åºå›¾ã€‚</p>
                </a>
            </div>
        </div>
        
        
        <div class="article-footer">
            <a href="../diary.html" class="back-btn">â† è¿”å›æ—¥è®°åˆ—è¡¨</a>
        </div>
    </main>

    <!-- é¡µè„šå°†é€šè¿‡ components-loader.js è‡ªåŠ¨åŠ è½½ -->
    
    <script src="../script.js"></script>
</body>
</html>

